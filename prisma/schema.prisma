generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── Card Data ───────────────────────────────────────────

model Set {
  id          String    @id @default(cuid())
  name        String    @unique // Alpha, Beta, Gothic, etc.
  slug        String    @unique // alpha, beta, gothic
  releasedAt  DateTime?
  description String?
  cardCount   Int       @default(0)

  cardSets CardSet[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Card {
  id         String   @id @default(cuid())
  name       String   @unique
  type       String   // Minion, Magic, Site, Aura, Artifact, Avatar
  rarity     String?  // Ordinary, Exceptional, Elite, Unique
  rulesText  String?
  cost       Int?
  attack     Int?
  defence    Int?
  life       Int?
  subTypes   String[] // ["Beast", "Dragon"] — proper array

  // Elements as array for clean filtering
  elements   String[] // ["Fire", "Water"]

  // Element thresholds
  thresholdAir   Int @default(0)
  thresholdEarth Int @default(0)
  thresholdFire  Int @default(0)
  thresholdWater Int @default(0)

  // Parsed keywords from rules text
  keywords   String[] // ["Spellcaster", "Airborne", "Genesis"]

  sets     CardSet[]
  variants CardVariant[]

  collectionCards CollectionCard[]
  deckCards       DeckCard[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CardSet {
  id         String   @id @default(cuid())

  set      Set      @relation(fields: [setId], references: [id], onDelete: Cascade)
  setId    String
  card     Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  cardId   String

  // Set-specific metadata (can differ from card defaults across printings)
  rarity     String?
  type       String?
  rulesText  String?
  cost       Int?
  attack     Int?
  defence    Int?
  life       Int?
  thresholdAir   Int?
  thresholdEarth Int?
  thresholdFire  Int?
  thresholdWater Int?

  variants CardVariant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cardId, setId])
}

model CardVariant {
  id          String  @id @default(cuid())
  slug        String  @unique // e.g. "alp-apprentice_wizard-b-s"
  finish      String  // Standard, Foil, Rainbow
  product     String  // Booster, Kickstarter, Box_Topper, etc.
  artist      String?
  flavorText  String?
  typeText    String?
  blurDataUrl String? // tiny base64 blur placeholder for next/image

  card     Card    @relation(fields: [cardId], references: [id], onDelete: Cascade)
  cardId   String
  set      CardSet @relation(fields: [setId], references: [id], onDelete: Cascade)
  setId    String

  collectionCards CollectionCard[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── User Data ───────────────────────────────────────────

model User {
  id          String       @id @default(cuid())
  email       String       @unique
  name        String?
  collections Collection[]
  decks       Deck[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Collection {
  id     String           @id @default(cuid())
  name   String
  user   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  cards  CollectionCard[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CollectionCard {
  id           String     @id @default(cuid())
  quantity     Int        @default(1)
  condition    String     @default("NM") // NM, LP, MP, HP, DMG
  notes        String?

  collection   Collection  @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  collectionId String
  card         Card        @relation(fields: [cardId], references: [id], onDelete: Cascade)
  cardId       String
  variant      CardVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  variantId    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([collectionId, variantId])
}

model Deck {
  id     String     @id @default(cuid())
  name   String
  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  cards  DeckCard[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DeckCard {
  id       String  @id @default(cuid())
  quantity Int     @default(1)
  owned    Boolean @default(false)
  deck     Deck    @relation(fields: [deckId], references: [id], onDelete: Cascade)
  deckId   String
  card     Card    @relation(fields: [cardId], references: [id], onDelete: Cascade)
  cardId   String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([deckId, cardId])
}
