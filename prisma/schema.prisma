generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── Card Data ───────────────────────────────────────────

model Set {
  id          String    @id @default(cuid())
  name        String    @unique // Alpha, Beta, Gothic, etc.
  slug        String    @unique // alpha, beta, gothic
  releasedAt  DateTime?
  description String?
  cardCount   Int       @default(0)

  cardSets CardSet[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Card {
  id         String   @id @default(cuid())
  name       String   @unique
  type       String   // Minion, Magic, Site, Aura, Artifact, Avatar
  rarity     String?  // Ordinary, Exceptional, Elite, Unique
  rulesText  String?
  cost       Int?
  attack     Int?
  defence    Int?
  life       Int?
  subTypes   String[] // ["Beast", "Dragon"] — proper array

  // Elements as array for clean filtering
  elements   String[] // ["Fire", "Water"]

  // Element thresholds
  thresholdAir   Int @default(0)
  thresholdEarth Int @default(0)
  thresholdFire  Int @default(0)
  thresholdWater Int @default(0)

  // Parsed keywords from rules text
  keywords   String[] // ["Spellcaster", "Airborne", "Genesis"]

  sets     CardSet[]
  variants CardVariant[]

  collectionCards CollectionCard[]
  deckCards       DeckCard[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CardSet {
  id         String   @id @default(cuid())

  set      Set      @relation(fields: [setId], references: [id], onDelete: Cascade)
  setId    String
  card     Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  cardId   String

  // Set-specific metadata (can differ from card defaults across printings)
  rarity     String?
  type       String?
  rulesText  String?
  cost       Int?
  attack     Int?
  defence    Int?
  life       Int?
  thresholdAir   Int?
  thresholdEarth Int?
  thresholdFire  Int?
  thresholdWater Int?

  variants CardVariant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cardId, setId])
}

model CardVariant {
  id          String  @id @default(cuid())
  slug        String  @unique // e.g. "alp-apprentice_wizard-b-s"
  finish      String  // Standard, Foil, Rainbow
  product     String  // Booster, Kickstarter, Box_Topper, etc.
  artist      String?
  flavorText  String?
  typeText    String?
  blurDataUrl String? // tiny base64 blur placeholder for next/image

  card     Card    @relation(fields: [cardId], references: [id], onDelete: Cascade)
  cardId   String
  set      CardSet @relation(fields: [setId], references: [id], onDelete: Cascade)
  setId    String

  collectionCards    CollectionCard[]
  tcgplayerProducts  TcgplayerProduct[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Pricing Data ────────────────────────────────────────

model TcgplayerProduct {
  id             Int              @id // TCGplayer productId
  cardName       String           // card name on TCGplayer
  setName        String           // set name on TCGplayer (Alpha, Beta, etc.)
  printing       String           // "Normal" or "Foil"
  productUrl     String           // URL-safe name for link construction

  // Link to our data — nullable until matched
  variant        CardVariant?     @relation(fields: [variantId], references: [id], onDelete: SetNull)
  variantId      String?

  priceSnapshots PriceSnapshot[]

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([variantId])
  @@index([cardName, setName, printing])
}

model PriceSnapshot {
  id                   Int              @id @default(autoincrement())
  tcgplayerProduct     TcgplayerProduct @relation(fields: [tcgplayerProductId], references: [id], onDelete: Cascade)
  tcgplayerProductId   Int
  marketPrice          Float?
  lowPrice             Float?
  medianPrice          Float?
  recordedAt           DateTime         @default(now())

  @@index([tcgplayerProductId, recordedAt])
}

// ─── User Data ───────────────────────────────────────────

model User {
  id          String       @id // Supabase auth.users UUID
  email       String       @unique
  name        String?
  avatarUrl   String?
  plan        String       @default("free") // free | premium

  collections Collection[]
  decks       Deck[]
  subscription Subscription?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Subscription {
  id                String   @id @default(cuid())
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String   @unique
  stripeCustomerId  String?  @unique
  stripePriceId     String?
  status            String   @default("inactive") // active | inactive | past_due | canceled
  currentPeriodEnd  DateTime?
  cancelAtPeriodEnd Boolean  @default(false)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Collection {
  id          String           @id @default(cuid())
  name        String
  description String?
  slug        String?          @unique // for shareable URLs
  isPublic    Boolean          @default(false)

  user   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  cards  CollectionCard[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model CollectionCard {
  id              String     @id @default(cuid())
  quantity        Int        @default(1)
  condition       String     @default("NM") // NM, LP, MP, HP, DMG
  notes           String?
  purchasePrice   Float?     // what user paid per unit
  purchasedAt     DateTime?  // when they bought it

  collection   Collection  @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  collectionId String
  card         Card        @relation(fields: [cardId], references: [id], onDelete: Cascade)
  cardId       String
  variant      CardVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  variantId    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([collectionId, variantId])
  @@index([collectionId])
}

model Deck {
  id     String     @id @default(cuid())
  name   String
  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  cards  DeckCard[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DeckCard {
  id       String  @id @default(cuid())
  quantity Int     @default(1)
  owned    Boolean @default(false)
  deck     Deck    @relation(fields: [deckId], references: [id], onDelete: Cascade)
  deckId   String
  card     Card    @relation(fields: [cardId], references: [id], onDelete: Cascade)
  cardId   String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([deckId, cardId])
}
